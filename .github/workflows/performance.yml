name: Performance Monitoring

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/public/**'
      - 'backend/resources/**'
      - 'backend/vite.config.js'
      - 'backend/tailwind.config.js'
  pull_request:
    paths:
      - 'backend/public/**'
      - 'backend/resources/**'
      - 'backend/vite.config.js'
      - 'backend/tailwind.config.js'
  schedule:
    - cron: '0 6 * * 1,3,5'  # Monday, Wednesday, Friday at 6 AM
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Performance test type'
        required: true
        default: 'load'
        type: choice
        options:
        - load
        - bundle
        - lighthouse
        - all
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '20'

jobs:
  bundle-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      working-directory: ./backend
      run: npm ci

    - name: Build and analyze bundle
      working-directory: ./backend
      run: |
        npm run build
        npx webpack-bundle-analyzer public/build/manifest.json --report bundle-report.html --mode static

    - name: Check bundle size
      working-directory: ./backend
      run: |
        echo "## Bundle Size Analysis" > bundle-size-report.md
        echo "### Asset Sizes" >> bundle-size-report.md
        find public/build -name "*.js" -o -name "*.css" | while read file; do
          size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
          echo "- $file: $(($size / 1024))KB" >> bundle-size-report.md
        done

    - name: Check for large assets
      working-directory: ./backend
      run: |
        echo "### Large Assets (>500KB)" >> bundle-size-report.md
        find public/build -name "*.js" -o -name "*.css" -size +500k | while read file; do
          size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
          echo "⚠️ $file: $(($size / 1024))KB" >> bundle-size-report.md
        done

    - name: Upload bundle analysis
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis
        path: |
          backend/bundle-report.html
          backend/bundle-size-report.md
        retention-days: 30

  lighthouse-audit:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'lighthouse' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install LHCI
      run: npm install -g @lhci/cli@0.12.x

    - name: Run Lighthouse CI
      run: |
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        LHCI_BUILD_CONTEXT: ${{ github.ref }}

    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-results
        path: .lighthouseci/
        retention-days: 30

  load-testing:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'all'
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Create load test script
      run: |
        cat > load-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        
        export let options = {
          stages: [
            { duration: '2m', target: 100 },
            { duration: '5m', target: 100 },
            { duration: '2m', target: 0 },
          ],
        };
        
        export default function () {
          let response = http.get('${{ secrets[format('{0}_URL', github.event.inputs.environment || 'staging')] }}/api/health');
          check(response, {
            'status was 200': (r) => r.status == 200,
            'response time < 500ms': (r) => r.timings.duration < 500,
          });
          sleep(1);
        }
        EOF

    - name: Run load test
      run: k6 run --out json=load-test-results.json load-test.js

    - name: Generate load test report
      run: |
        echo "# Load Test Report - $(date)" > load-test-report.md
        echo "## Test Configuration" >> load-test-report.md
        echo "- Duration: 9 minutes" >> load-test-report.md
        echo "- Max users: 100" >> load-test-report.md
        echo "- Target: ${{ secrets[format('{0}_URL', github.event.inputs.environment || 'staging')] }}" >> load-test-report.md
        echo "## Results" >> load-test-report.md
        cat load-test-results.json | jq '.metrics.http_req_duration.values."95"' >> load-test-report.md

    - name: Upload load test results
      uses: actions/upload-artifact@v4
      with:
        name: load-test-results
        path: |
          load-test-results.json
          load-test-report.md
        retention-days: 30

  performance-regression:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      working-directory: ./backend
      run: npm ci

    - name: Build current branch
      working-directory: ./backend
      run: npm run build

    - name: Measure bundle size
      working-directory: ./backend
      run: |
        du -sh public/build/ > current-bundle-size.txt

    - name: Build base branch
      run: |
        git checkout origin/${{ github.base_ref }}
        npm ci
        npm run build
        du -sh public/build/ > base-bundle-size.txt

    - name: Compare bundle sizes
      run: |
        echo "# Bundle Size Comparison" > size-comparison.md
        echo "## Base Branch (${{ github.base_ref }})" >> size-comparison.md
        cat base-bundle-size.txt >> size-comparison.md
        echo "## Current Branch (${{ github.head_ref }})" >> size-comparison.md
        cat current-bundle-size.txt >> size-comparison.md

    - name: Comment PR with results
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const comparison = fs.readFileSync('size-comparison.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comparison
          });

    - name: Upload comparison results
      uses: actions/upload-artifact@v4
      with:
        name: size-comparison
        path: |
          size-comparison.md
          current-bundle-size.txt
          base-bundle-size.txt
        retention-days: 30

  uptime-monitoring:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    strategy:
      matrix:
        environment: [staging, production]

    steps:
    - name: Check uptime
      run: |
        echo "# Uptime Monitoring - $(date)" > uptime-report-${{ matrix.environment }}.md
        echo "## Environment: ${{ matrix.environment }}" >> uptime-report-${{ matrix.environment }}.md
        
        # Test health endpoint
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets[format('{0}_URL', matrix.environment)] }}/health)
        if [ "$response" = "200" ]; then
          echo "✅ Health endpoint: $response" >> uptime-report-${{ matrix.environment }}.md
        else
          echo "❌ Health endpoint: $response" >> uptime-report-${{ matrix.environment }}.md
        fi
        
        # Test response time
        response_time=$(curl -s -o /dev/null -w "%{time_total}" ${{ secrets[format('{0}_URL', matrix.environment)] }}/health)
        echo "Response time: ${response_time}s" >> uptime-report-${{ matrix.environment }}.md

    - name: Upload uptime reports
      uses: actions/upload-artifact@v4
      with:
        name: uptime-reports
        path: uptime-report-*.md
        retention-days: 30